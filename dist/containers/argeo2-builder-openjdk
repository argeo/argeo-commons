#!/bin/sh

container=$(buildah from centos:centos8)

buildah config --label release="1" $container
# Use argeo-osgi-plugin version for the time being
buildah config --label version="2.1.1" $container

source "$(dirname "$0")/buildah-common"

# Metadata
buildah config --label name="argeo2-builder-openjdk11-ubi8" $container
buildah config --label summary="Argeo 2 Builder based on OpenJDK 11 and Red Hat UBI 8" $container

# Utilities
buildah run $container -- dnf -y install rpm-build
buildah run $container -- dnf -y install git

# Java 11
buildah run $container -- dnf -y install java-11-openjdk-devel
# Maven
buildah run $container -- dnf -y install maven

# Perform a build of argeo-commons
buildah run $container -- mkdir -p /root/dev/git/apache2/
buildah run $container -- mkdir -p /srv/rpmfactory/
buildah run $container -- mkdir -p /srv/javafactory/
buildah run $container -- git clone http://git.argeo.org/apache2/argeo-commons.git /root/dev/git/apache2/argeo-commons
buildah run $container -- "cd /root/dev/git/apache2/argeo-commons && mvn clean argeo-osgi:pde-sources deploy -Prpmbuild"
buildah run $container -- "cd /root/dev/git/apache2/argeo-commons && mvn dependency:go-offline"

# TODO clean up build directories

# Configuration
buildah config --workingdir /root/dev/git/ $container

buildah commit $container argeo2-builder-openjdk:latest
