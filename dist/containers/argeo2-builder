#!/bin/sh

container=$(buildah from ubi8/ubi-minimal)


source "$(dirname "$0")/buildah-common"

buildah config --label release="1" $container
buildah config --label version="$VERSION" $container

# Metadata
buildah config --label name="argeo2-builder-openjdk11-ubi8" $container
buildah config --label summary="Argeo 2 Builder based on OpenJDK 11 and Red Hat UBI 8" $container

# Utilities
#buildah run $container -- microdnf -y install git

# Java 11
buildah run $container -- microdnf -y install java-11-openjdk-devel
# Maven
buildah run $container -- microdnf -y install maven
buildah copy $container maven.conf /etc/java/maven.conf

buildah run $container -- mkdir -p /srv/javafactory/

# Working dir
buildah run $container -- mkdir -p /root/checkout/
buildah config --workingdir /root/checkout/ $container

# Perform a build of argeo-commons
#buildah run $container -- /usr/bin/git clone http://git.argeo.org/apache2/argeo-commons.git .
buildah copy $container ../.. /root/checkout
buildah run $container -- /usr/bin/mvn clean install
buildah run $container -- /usr/bin/mvn dependency:go-offline
# Clean up build directories
buildah run $container -- /usr/bin/rm -rf /root/.m2/repository/org/argeo/commons
buildah run $container -- /usr/bin/rm -rf /root/checkout
buildah run $container -- mkdir -p /root/checkout/

# Configuration
#buildah config --workingdir /root/checkout/ $container
#buildah config --entrypoint '["/usr/bin/mvn","clean","deploy"]' $container
buildah config --cmd '/usr/bin/mvn clean deploy' $container

buildah commit $container argeo2-builder:latest
