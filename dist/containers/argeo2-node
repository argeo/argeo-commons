#!/bin/sh

source "$(dirname "$0")/buildah-metadata"
container=$(buildah from argeo2-tp:v$VERSION_ARGEO_TP)

# Override version
VERSION=2.1.83

source "$(dirname "$0")/buildah-common"

buildah config --label release="1" $container
buildah config --label version="$VERSION" $container

# Metadata
buildah config --label name="argeo2-node" $container
buildah config --label description="Argeo 2 Node based on OpenJDK 11 and Red Hat UBI 8" $container
buildah config --label url=https://hub.docker.com/repository/docker/argeo/argeo2-node $container

# Required as long as we declare an 'argeo' user
buildah run $container -- microdnf install shadow-utils

# Argeo OSGi Boot
buildah run $container -- microdnf install osgi-boot
# Argeo Node
buildah run $container -- microdnf install argeo-cms-e4-rap argeo-node

# Configuration
buildah config --entrypoint '["/usr/sbin/argeoctl","start"]' $container
buildah config --port 8080 $container

buildah commit --rm --format docker $container argeo2-node:v$VERSION
buildah push argeo2-node:v$VERSION docker://argeo/argeo2-node:v$VERSION
buildah push argeo2-node:v$VERSION docker://argeo/argeo2-node:latest
